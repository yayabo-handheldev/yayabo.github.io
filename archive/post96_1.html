
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>SDL video子系统学习 (三)</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    </head>

    <body style="margin-top:1.618%">
        <div class="container">
            <div class="row">
                <div class="jumbotron">
                    <h1 class="display-5">SDL video子系统学习 (三)</h1>
                </div>
                <br />
                <nav class="nav">
                    <a class="nav-link active" aria-current="page" href="index_1.html">返回</a>
                </nav>
            </div>

            <hr class="my-4" />
<div class="row">
<div class="col-2">
<p><b>掌叔</b><br/>
2008-06-10 09:23:18</p>
</div>
<div class="col-10">
<p>摘自：[url]http://blog.sina.com.cn/vcbear[/url]<br />作者：vcbear<br /><br /> 学习了如何装载位图和键盘控制后，我们就可以写个基本的小游戏了，下面是依据老外的文章照葫芦画瓢做的一个小游戏。下面是截图：左右光标键控制QQ移动，Enter键发子弹<br />[attach]90[/attach]<br />下面是完整的源码：<br />----------------------------------------------------------------------<br /> <br /><br />/***************************************************************************<br /> *   Copyright (C) 2006 by xhh   *<br /> *   huyinlin@XHH   *<br /> *                                                                         *<br /> *   This program is free software; you can redistribute it and/or modify  *<br /> *   it under the terms of the GNU General Public License as published by  *<br /> *   the Free Software Foundation; either version 2 of the License, or     *<br /> *   (at your option) any later version.                                   *<br /> *                                                                         *<br /> *   This program is distributed in the hope that it will be useful,       *<br /> *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *<br /> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *<br /> *   GNU General Public License for more details.                          *<br /> *                                                                         *<br /> *   You should have received a copy of the GNU General Public License     *<br /> *   along with this program; if not, write to the                         *<br /> *   Free Software Foundation, Inc.,                                       *<br /> *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *<br /> ***************************************************************************/<br /><br />#include <iostream><br />#include <stdio.h><br />#include "libnge.h"<br />#include <SDL_mixer.h> //不是SDL标准包，但可很方便地操纵音频<br /><br /> <br /><br />using namespace std;<br /><br />const int MAXALIENS = 50;<br />const int MAXSHOTS = 4;<br />const int MAXUPDATES = 2 * (MAXSHOTS + MAXALIENS + 1);<br />const int FPS = 100;  //帧速<br />const int PLAYER_SPEED = 5;<br />const int SHOT_SPEED = 8;<br />const int ALIEN_SPEED = 2;<br />const int EXPLODE_TIME = 4;<br /><br />enum<br />{<br /> MUSIC_WAV,<br /> SHOT_WAV,<br /> EXPLODE_WAV,<br /> NUM_WAVES<br />};<br /><br />Mix_Chunk *sounds[NUM_WAVES]; //音频数组<br /><br />SDL_Surface *screen, *back;   //屏幕和背景<br /><br />typedef struct<br />{<br /> int x, y;                    //游戏元素横纵坐标<br /> int alive;                   //游戏元素生存状态<br /> int faceing;                 //游戏元素方向<br /> SDL_Surface *img;            //游戏元素图象<br />} object;<br /><br />object me;                    //玩家<br />object aliens[MAXALIENS];     //目标<br />object shots[MAXSHOTS];       //子弹<br />object explosion[MAXALIENS + 1];  //击中效果<br /><br />SDL_Rect src[MAXUPDATES], dst[MAXUPDATES];  //各个分散的要更新的区域<br />int numupdates;   //要更新的区域数目<br />int reloading;<br /><br />typedef struct<br />{<br /> SDL_Surface *img;<br /> SDL_Rect *src, *dst;<br />} blit;           //贴图结构<br /><br />blit blits[MAXUPDATES];<br /><br />SDL_Surface * LoadImg (const char *name) //装入图象<br />{<br /> SDL_Surface *tmp, *ok;<br /> if ((tmp = SDL_LoadBMP (name)) == NULL)<br /> {<br />  fprintf (stderr, "load %s error", name);<br />  return NULL;<br /> }<br /> SDL_SetColorKey (tmp, SDL_SRCCOLORKEY | SDL_RLEACCEL,*(Uint8 *) tmp->pixels);  //抠图处理<br /> ok = SDL_DisplayFormat (tmp);<br /> SDL_FreeSurface (tmp);<br /> return ok;<br />}<br /><br />void LoadData ()           //加载游戏元素<br />{<br /> int i;<br /> <br /> //游戏图象<br /> me.img = LoadImg ("player.bmp");<br /> aliens[0].img = LoadImg ("alien.bmp");<br /> shots[0].img = LoadImg ("shot.bmp");<br /> explosion[0].img = LoadImg ("explosion.bmp");<br /> back = LoadImg ("back.bmp");<br /><br /> //游戏声音<br /> sounds[MUSIC_WAV] = Mix_LoadWAV ("music.wav");<br /> sounds[SHOT_WAV] = Mix_LoadWAV ("shot.wav");<br /> sounds[EXPLODE_WAV] = Mix_LoadWAV ("explode.wav");<br /><br /> //各数组初始化<br /> for (i = 1; i < MAXALIENS; i++)<br /> {<br />  aliens[i].img = aliens[0].img;<br /> }<br /> for (i = 1; i < MAXSHOTS; i++)<br /> {<br />  shots[i].img = shots[0].img;<br /> }<br /> for (i = 1; i < MAXALIENS + 1; i++)<br /> {<br />  explosion[i].img = explosion[0].img;<br /> }<br /> for (i = 0; i < MAXUPDATES; i++)<br /> {<br />  blits[i].src = &src[i];<br />  blits[i].dst = &dst[i];<br /> }<br />}<br /><br /><br />void FreeData ()              //释放游戏元素<br />{<br /> SDL_FreeSurface (me.img);<br /> SDL_FreeSurface (aliens[0].img);<br /> SDL_FreeSurface (shots[0].img);<br /> SDL_FreeSurface (explosion[0].img);<br />}<br /><br />void drawobject (object * sprite)  //游戏元素贴图准备<br />{<br /> blit *update;<br /> update = &blits[numupdates++];<br /> update->img = sprite->img;<br /> update->src->x = update->src->y = 0;<br /> update->src->w = sprite->img->w;<br /> update->src->h = sprite->img->h;<br /> update->dst->x = sprite->x;<br /> update->dst->y = sprite->y;<br /> update->dst->w = sprite->img->w;<br /> update->dst->h = sprite->img->h;<br />}<br /><br />void eraseobject (object * sprite) //用背景盖掉object<br />{<br /> blit *update;<br /> update = &blits[numupdates++];<br /> update->img = back;<br /> update->src->x = sprite->x;<br /> update->src->y = sprite->y;<br /> update->src->w = sprite->img->w;<br /> update->src->h = sprite->img->h;<br /> update->dst->x = sprite->x;<br /> update->dst->y = sprite->y;<br /> update->dst->w = sprite->img->w;<br /> update->dst->h = sprite->img->h;<br />}<br /><br />void wait ()<br />{<br /> static Uint32 next_tick = 0;<br /> Uint32 this_tick;<br /> this_tick = SDL_GetTicks ();<br /> if (this_tick < next_tick)<br />  SDL_Delay (next_tick - this_tick);<br /> next_tick = this_tick + 1000 / FPS;<br />}<br /><br />void Updatescene ()   //游戏元素贴图<br />{<br /> int i;<br /> for (i = 0; i < numupdates; i++)<br /> {<br />  SDL_BlitSurface (blits[i].img, blits[i].src, screen,blits[i].dst);<br /> }<br /> SDL_UpdateRects (screen, numupdates, dst);<br /> numupdates = 0; <br />}<br /><br />void creatalien ()    //创建目标<br />{<br /> int i = 0;<br /> for (i = 0; i < MAXALIENS; i++)<br /> {<br />  if (!aliens[i].alive)<br />   break;<br /> }<br /> if (i == MAXALIENS)<br />  return;<br /> do<br /> {<br />  aliens[i].faceing = (rand () % 3) - 1;<br /> }<br /> while (aliens[i].faceing == 0); //方向就只有 1 和-1了<br /> aliens[i].y = 10;<br /> if (aliens[i].faceing < 0)<br />  aliens[i].x = screen->w - aliens[i].img->w - 1;<br /> else<br />  aliens[i].x = 0;<br /> aliens[i].alive = 1;<br />}<br /><br />bool collision (object * sprite1, object * sprite2) //测试碰撞<br />{<br /> if ((sprite1->y >= (sprite2->y + sprite2->img->h)) ||<br />     (sprite1->x >= (sprite2->x + sprite2->img->w)) ||<br />     (sprite2->y >= (sprite1->y + sprite1->img->h)) ||<br />     (sprite2->x >= (sprite1->x + sprite1->img->w)))<br /> {<br />  return (false);<br /> }<br /> return (true);<br /><br />}<br /><br />void rungame ()      //启动游戏<br />{<br /> int j, i;<br /> SDL_Event event;<br /> Uint8 *keys;<br /> numupdates = 0;<br /> SDL_BlitSurface (back, NULL, screen, NULL);<br /> SDL_UpdateRect (screen, 0, 0, 0, 0);<br /> me.x = (screen->w - me.img->w) / 2;<br /> me.y = (screen->h - me.img->h) - 1;<br /> me.alive = 1;<br /> me.faceing = 0;<br /> for (i = 0; i < MAXALIENS; i++)<br />  aliens[i].alive = 0;<br /> for (i = 0; i < MAXSHOTS; i++)<br />  shots[i].alive = 0;<br /> drawobject (&me);<br /> creatalien ();<br /> drawobject (&aliens[0]);<br /> Updatescene ();<br /> while (me.alive)<br /> {<br />  wait (); //一帧一帧地运行<br />  while (SDL_PollEvent (&event))<br />   if (event.type == SDL_QUIT)<br />    return;<br />  keys = SDL_GetKeyState (NULL);<br />  if (keys[SDLK_ESCAPE])<br />   return;<br />  //在一帧里全部要更新<br />  for (i = 0; i < MAXALIENS; i++)<br />   if (aliens[i].alive)<br />    eraseobject (&aliens[i]);<br />  for (i = 0; i < MAXSHOTS; i++)<br />   if (shots[i].alive)<br />    eraseobject (&shots[i]);<br />  for (i = 0; i < MAXALIENS + 1; i++)<br />   if (explosion[i].alive)<br />    eraseobject (&explosion[i]);<br />  eraseobject (&me);<br />  //explosion计时<br />  for (i = 0; i < MAXALIENS + 1; i++)<br />  {<br />   if (explosion[i].alive)<br />    explosion[i].alive--;<br />  }<br />  //新产生一个aliens<br />  if ((rand () % FPS) == 0) //大约过FPS帧才产生一个，即一秒一个　<br />   creatalien ();<br />  //产生shot<br />  if (!reloading)<br />  {<br />//   if (keys[SDLK_SPACE] == SDL_PRESSED)<br />   if (keys[SDLK_RETURN] == SDL_PRESSED)<br />   {<br />    for (i = 0; i < MAXSHOTS; i++)<br />     if (!shots[i].alive)<br />      break;<br />    if (i != MAXSHOTS)<br />    {<br />     shots[i].x =<br />      me.x + (me.img->w -<br />       shots[i].img->w) / 2;<br />     shots[i].y = me.y - shots[i].img->h;<br />     shots[i].alive = 1;<br />     Mix_PlayChannel (SHOT_WAV,<br />        sounds[SHOT_WAV], 0);<br />    }<br />   }<br />  }<br />  reloading = (keys[SDLK_SPACE] == SDL_PRESSED);<br />  //移动自己<br />  me.faceing = 0;<br />  if (keys[SDLK_RIGHT])<br />   me.faceing++;<br />  if (keys[SDLK_LEFT])<br />   me.faceing--;<br />  me.x += me.faceing * PLAYER_SPEED;<br />  if (me.x < 0)<br />   me.x = 0;<br />  if (me.x > screen->w - me.img->w)<br />   me.x = screen->w - me.img->w - 1;<br />  //移动aliens<br />  for (i = 0; i < MAXALIENS; i++)<br />  {<br />   if (aliens[i].alive)<br />   {<br />    aliens[i].x +=<br />     aliens[i].faceing * ALIEN_SPEED;<br />    if (aliens[i].x < 0)<br />    {<br />     aliens[i].x = 0;<br />     aliens[i].faceing = 1;<br />     aliens[i].y += aliens[i].img->h;<br />    }<br />    if (aliens[i].x >=<br />        screen->w - aliens[i].img->w)<br />    {<br />     aliens[i].x =<br />      screen->w - aliens[i].img->w -<br />      1;<br />     aliens[i].faceing = -1;<br />     aliens[i].y += aliens[i].img->h;<br />    }<br />   }<br />  }<br />  //移动shot<br />  for (i = 0; i < MAXSHOTS; i++)<br />  {<br />   if (shots[i].alive)<br />   {<br />    shots[i].y -= SHOT_SPEED;<br />    if (shots[i].y < 0)<br />     shots[i].alive = 0;<br />   }<br />  }<br />  //测试碰撞<br />  for (i = 0; i < MAXSHOTS; i++)<br />   for (j = 0; j < MAXALIENS; j++)<br />   {<br />    if (shots[i].alive && aliens[j].alive&& collision (&shots[i], &aliens[j]))<br />    {<br />     shots[i].alive = 0;<br />     aliens[j].alive = 0;<br />     explosion[j].x = aliens[j].x;<br />     explosion[j].y = aliens[j].y;<br />     explosion[j].alive = EXPLODE_TIME;<br />     Mix_PlayChannel (EXPLODE_WAV,sounds[EXPLODE_WAV],0);<br />    }<br />   }<br />  for (i = 0; i < MAXALIENS; i++)<br />  {<br />   if (aliens[i].alive && me.alive&& collision (&me, &aliens[i]))<br />   {<br />    aliens[i].alive = 0;<br />    me.alive = 0;<br />    explosion[i].x = aliens[i].x;<br />    explosion[i].y = aliens[i].y;<br />    explosion[i].alive = EXPLODE_TIME;<br />    explosion[MAXALIENS].x = me.x;<br />    explosion[MAXALIENS].y = me.y;<br />    explosion[MAXALIENS].alive = EXPLODE_TIME;<br />    Mix_PlayChannel (EXPLODE_WAV,sounds[EXPLODE_WAV], 0);<br />   }<br />  }<br />  //draw所有的东东<br />  if (me.alive)<br />   drawobject (&me);<br />  for (i = 0; i < MAXALIENS; i++)<br />   if (aliens[i].alive)<br />    drawobject (&aliens[i]);<br />  for (i = 0; i < MAXSHOTS; i++)<br />   if (shots[i].alive)<br />    drawobject (&shots[i]);<br />  for (i = 0; i < MAXALIENS + 1; i++)<br />   if (explosion[i].alive)<br />    drawobject (&explosion[i]);<br />  Updatescene ();<br /> }<br /> while (Mix_Playing (EXPLODE_WAV))<br />  wait ();<br /> Mix_HaltChannel (-1);<br />}<br /><br /> <br /><br />extern "C"<br />int main(int argc, char* argv[])<br />{<br /> /* Initialize the SDL library */<br /> if( SDL_Init(SDL_INIT_VIDEO) < 0 )<br /> {<br />  fprintf(stderr,"Couldn't initialize SDL: %s<br />", SDL_GetError());<br />  exit(1);<br /> }<br /><br /> /* Clean up on exit */<br />    atexit(SDL_Quit);<br /><br /> /*<br /> * Initialize the display in a 640x480 8-bit palettized mode,<br /> * requesting a software surface<br /> */<br />    screen = SDL_SetVideoMode(640, 480, 32, SDL_HWSURFACE | SDL_DOUBLEBUF);<br /> if ( screen == NULL )<br /> {<br />  fprintf(stderr, "Couldn't set 640x480x8 video mode: %s<br />",SDL_GetError());<br />  exit(1);<br /> }<br /><br /> SDL_WM_SetCaption ("vcbear", "vcbear");<br /> if (Mix_OpenAudio (11025, AUDIO_U8, 1, 512) < 0)<br /> {<br />  fprintf (stderr,"Warning: Couldn't set 11025 Hz 8-bit audio<br />- Reason: %s<br />",SDL_GetError ());<br /> }<br />   // srand(time(NULL));<br /> <br /> LoadData ();<br /> rungame ();<br /> FreeData ();<br /> Mix_CloseAudio ();<br />    <br /> exit(0);<br />}</p>
</div>
</div>


            
            <div class="row">
                <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-center">
                    <!--<li class="page-item disabled">
                        <a class="page-link">Previous</a>
                    </li>
                    <li class="page-item"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item">
                        <a class="page-link" href="#">Next</a>
                    </li>
                        -->
                        <li class="page-item active">
<a class="page-link" href="post96_1.html">1</a>
</li>


                    </ul>
                </nav>
            </div>
        </div>


        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
    </body>
</html>

